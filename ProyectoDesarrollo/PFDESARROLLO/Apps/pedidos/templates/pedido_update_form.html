{% extends 'baseusuarios.html' %} 
{% load static %}
{% load widget_tweaks %}

{% block title %}
     {% if pedido.pk %}Editar Pedido #{{ pedido.pk }}{% else %}Crear Nuevo Pedido{% endif %}
{% endblock %}

{% block contenido %}
<section class="py-5 background-pattern bg-info">
    <div class="container my-4">

        {# --- ENCABEZADO PRINCIPAL --- #}
        <div class="p-3 mb-4 rounded-3 bg-white shadow-sm text-center">
            <h1 class="text-dark fw-bold mb-0">
                {% if pedido.pk %}
                     Editar Pedido #{{ pedido.pk }}
                {% else %}
                     Crear Nuevo Pedido
                {% endif %}
            </h1>
        </div>
        
        <div class="bg-white p-4 p-md-5 rounded-3 shadow-lg">
            
            <form method="post" id="pedido-form"> 
                {% csrf_token %}
                {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Error en la Cabecera</h4>
                    {{ form.non_field_errors }}
                </div>
                {% endif %}
                
                <h3 class="mt-2 mb-3 pb-2 border-bottom text-primary fw-bold">
                    <i class="fas fa-file-alt me-2"></i> Informaci贸n General
                </h3>
                
                <div class="row g-4 p-3 mb-5 border rounded-3 bg-light">
                    {% for field in form %}
                        <div class="col-md-6 col-lg-4">
                            <div class="form-group">
                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold">{{ field.label }}</label>
                                {% if field.name == 'id_usuario' or field.name == 'id_direccion' or field.name == 'estado_pedido' or field.name == 'estado' %}
                                    {% if field.name == 'estado' and not pedido.pk %}
                                        {# L贸gica para fijar 'estado' a 'Activo' (asumiendo valor 1) en creaci贸n #}
                                        <div class="input-group">
                                            <span class="form-control bg-success text-white fw-bold">Activo</span>
                                            <input type="hidden" name="{{ field.name }}" id="{{ field.id_for_label }}" value="1">
                                        </div>
                                    {% else %}
                                        {# Muestra el campo normalmente (incluida la edici贸n del estado) #}
                                        {% render_field field class="form-select" %}
                                    {% endif %}
                                {% else %}
                                    {# Renderiza cualquier otro campo con form-control #}
                                    {% render_field field class="form-control" %}
                                {% endif %}
                                
                                {% if field.help_text %}
                                    <div class="form-text text-muted">{{ field.help_text }}</div>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="text-danger small mt-1"><i class="fas fa-times-circle me-1"></i> {{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <h3 class="mt-4 mb-3 pb-2 border-bottom text-primary fw-bold">
                    <i class="fas fa-list me-2"></i> Art铆culos del Pedido
                </h3>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-0">
                        
                        {% if articulos_formset.errors %}
                        <div class="alert alert-warning m-3" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i> Hay errores en los art铆culos. Revise si hay filas vac铆as o datos incorrectos.
                            {{ articulos_formset.non_form_errors }}
                        </div>
                        {% endif %}

                        {{ articulos_formset.management_form }}
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0" id="articulos-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Producto Comprado</th>
                                        <th style="width: 15%;" class="text-center">Cantidad</th>
                                        <th style="width: 20%;" class="text-end">Precio Unitario</th>
                                        <th style="width: 5%;" class="text-center">Quitar</th>
                                    </tr>
                                </thead>
                                <tbody id="formset-container">
                                    {% for form_articulo in articulos_formset %}
                                    <tr class="align-middle dynamic-form-row {% if form_articulo.errors %}table-danger{% endif %}">
                                        
                                        <td>
                                            <div style="min-width: 180px;">
                                                {{ form_articulo.id_producto|attr:'class:producto-select form-select' }} 
                                            </div>
                                            {% for error in form_articulo.id_producto.errors %}<small class="text-danger d-block">{{ error }}</small>{% endfor %}
                                        </td>

                                        <td>
                                            <div style="max-width: 100px;" class="mx-auto"> 
                                                {{ form_articulo.cantidad|attr:'class:form-control text-end' }}
                                            </div>
                                            {% for error in form_articulo.cantidad.errors %}<small class="text-danger d-block">{{ error }}</small>{% endfor %}
                                        </td>

                                        <td>
                                            <div style="max-width: 120px;" class="ms-auto me-2">
                                                {{ form_articulo.precio_unitario|attr:'class:precio-input form-control text-end'|attr:'readonly:true' }} 
                                            </div>
                                            {% for error in form_articulo.precio_unitario.errors %}<small class="text-danger d-block">{{ error }}</small>{% endfor %}
                                        </td>
                                        
                                        <td class="text-center align-middle">
                                            {# Checkbox de DELETE para filas existentes #}
                                            <div class="form-check form-switch d-inline-block">
                                                {{ form_articulo.DELETE }}
                                                <label class="form-check-label text-danger" for="{{ form_articulo.DELETE.id_for_label }}">
                                                    <i class="fas fa-trash-alt"></i>
                                                </label>
                                            </div>
                                            
                                            {% for hidden in form_articulo.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    {% endfor %}

                                    {% with form_articulo=articulos_formset.empty_form %}
                                    <tr id="empty-form-template" style="display: none;" class="align-middle dynamic-form-row">
                                        <td>
                                            <div style="min-width: 180px;">
                                                {{ form_articulo.id_producto|attr:'class:producto-select form-select' }} 
                                            </div>
                                        </td>
                                        <td>
                                            <div style="max-width: 100px;" class="mx-auto"> 
                                                {{ form_articulo.cantidad|attr:'class:form-control text-end' }}
                                            </div>
                                        </td>
                                        <td>
                                            <div style="max-width: 120px;" class="ms-auto me-2">
                                                {{ form_articulo.precio_unitario|attr:'class:precio-input form-control text-end'|attr:'readonly:true' }}
                                            </div>
                                        </td>
                                        <td class="text-center align-middle">
                                            {# Bot贸n para quitar filas NUEVAS #}
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-form-row">
                                                <i class="fas fa-trash-alt"></i> Quitar
                                            </button>
                                            {% for hidden in form_articulo.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    {% endwith %}

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                    <button type="button" class="btn btn-success shadow" id="add-item-btn">
                        <i class="fas fa-plus-circle me-1"></i> Agregar Nuevo Art铆culo
                    </button>
                    <div>
                        <button type="submit" class="btn btn-lg btn-primary me-3 shadow">
                            <i class="fas fa-save me-2"></i> Guardar Cambios
                        </button>
                        <a href="{% url 'pedidos:pedido_list' %}" class="btn btn-lg btn-secondary shadow">
                            <i class="fas fa-times-circle me-2"></i> Cancelar
                        </a>
                    </div>
                </div>

            </form>
        </div>
    </div>
</section>
    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 

<script>
    $(document).ready(function() {
        var $container = $('#formset-container');
        var $totalForms = $('#id_{{ articulos_formset.prefix }}-TOTAL_FORMS');
        var $template = $('#empty-form-template');
        var prefix = '{{ articulos_formset.prefix }}';

        function updateFormIndices() {
            var currentForms = $container.find('.dynamic-form-row:not(#empty-form-template)').filter(function() {
                var deleteCheckbox = $(this).find('input[type="checkbox"][id$="-DELETE"]');
                return deleteCheckbox.length === 0 || !deleteCheckbox.prop('checked');
            });
            
            currentForms.each(function(index) {
                var $row = $(this);
                $row.find(':input, label').each(function() {
                    var name = $(this).attr('name');
                    var id = $(this).attr('id');
                    var htmlFor = $(this).attr('for');

                    if (name) {
                        name = name.replace(new RegExp('^' + prefix + '-(\\d+)-'), prefix + '-' + index + '-');
                        $(this).attr('name', name);
                    }
                    if (id) {
                        id = id.replace(new RegExp('^id_' + prefix + '-(\\d+)-'), 'id_' + prefix + '-' + index + '-');
                        $(this).attr('id', id);
                    }
                    if (htmlFor) {
                        htmlFor = htmlFor.replace(new RegExp('^id_' + prefix + '-(\\d+)-'), 'id_' + prefix + '-' + index + '-');
                        $(this).attr('for', htmlFor);
                    }
                });
            });
            $totalForms.val(currentForms.length);
        }

        // L贸gica para AADIR FILA
        $('#add-item-btn').on('click', function(e) {
            e.preventDefault();
            
            var newIndex = parseInt($totalForms.val());
            var newFormRow = $template.clone(true);
            
            var html = newFormRow.html().replace(/__prefix__/g, newIndex);
            newFormRow.html(html);

            newFormRow.removeAttr('id').removeAttr('style');

            newFormRow.find('input:not([type="hidden"]), select').val('');

            $container.append(newFormRow); 

            $totalForms.val(newIndex + 1);

            newFormRow.find('.producto-select').first().focus();
            
            updateFormIndices();
        });

        // L贸gica para QUITAR FILA btn
        $container.on('click', '.remove-form-row', function(e) {
            e.preventDefault();
            
            var $row = $(this).closest('.dynamic-form-row');
            $row.remove();
            
            updateFormIndices();
        });

        // L贸gica para marcar filas existentes para eliminaci贸n del
        $container.on('change', 'input[type="checkbox"][id$="-DELETE"]', function() {
            var $row = $(this).closest('.dynamic-form-row');
            if ($(this).is(':checked')) {
                $row.addClass('table-danger');
            } else {
                $row.removeClass('table-danger');
            }
            updateFormIndices();
        });

        // --- L贸gica AJAX precio auto
        $container.on('change', '.producto-select', function() {
            var $select = $(this);
            var productoId = $select.val(); 
            
            var $row = $select.closest('.dynamic-form-row');
            var $precioInput = $row.find('.precio-input');

            if (productoId) {
                $.ajax({
                    url: "{% url 'pedidos:obtener_precio_producto' %}", 
                    data: {
                        'producto_id': productoId 
                    },
                    dataType: 'json',
                    success: function (data) {
                        var precio = parseFloat(data.precio) || 0.00; 
                        $precioInput.val(precio.toFixed(2));
                    },
                    error: function() {
                        $precioInput.val('0.00');
                    }
                });
            } else {
                $precioInput.val('0.00');
            }
        });

        updateFormIndices(); 
        $container.find('input[type="checkbox"][id$="-DELETE"]:checked').closest('.dynamic-form-row').addClass('table-danger');
    });
</script>
{% endblock %}