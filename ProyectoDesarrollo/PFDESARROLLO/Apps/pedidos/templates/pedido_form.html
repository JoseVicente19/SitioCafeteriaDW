{% extends 'baseusuarios.html' %} 

{% load widget_tweaks %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        Editar Pedido #{{ form.instance.pk }}
    {% else %}
        Crear Nuevo Pedido
    {% endif %}
{% endblock %}

{% block contenido %}
<section class="py-5 background-pattern bg-info">
    <div class="container my-4">
        
        <div class="p-3 mb-4 rounded-3 bg-light shadow-sm text-center">
            <h1 class="text-dark fw-bold mb-0">
                {% if form.instance.pk %}
                     Editar Pedido #{{ form.instance.pk }}
                {% else %}
                     Crear Nuevo Pedido
                {% endif %}
            </h1>
        </div>

        <div class="bg-white p-4 p-md-5 rounded-3 shadow-lg">
            
            <form method="post" id="pedido-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Error en la Cabecera del Pedido</h4>
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <h3 class="mt-2 mb-3 pb-2 border-bottom text-primary fw-bold">
                    <i class="fas fa-file-alt me-2"></i> Informaci贸n del Pedido
                </h3>
                
                <div class="row g-4 p-3 mb-5 border rounded-3 bg-light">
                    {% for field in form %}
                        <div class="col-md-6 col-lg-4">
                            <div class="form-group">
                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold">{{ field.label }}</label>
                                {% render_field field class="form-control" %}
                                
                                {% if field.help_text %}
                                    <div class="form-text text-muted">{{ field.help_text }}</div>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="text-danger small mt-1"><i class="fas fa-times-circle me-1"></i> {{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <h3 class="mt-4 mb-3 pb-2 border-bottom text-primary fw-bold">
                    <i class="fas fa-list me-2"></i> Art铆culos del Pedido
                </h3>
                
                {% if articulos_formset.non_field_errors %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-circle me-2"></i> {{ articulos_formset.non_field_errors }}
                    </div>
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle mb-0" id="articulos-table">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Producto</th>
                                <th scope="col" style="width: 15%;">Cantidad</th>
                                <th scope="col" style="width: 20%;">Precio Unitario</th>
                                <th scope="col" style="width: 10%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="formset-container">
                            {{ articulos_formset.management_form }} 

                            {% for form_detalle in articulos_formset %}
                                <tr class="{% if form_detalle.errors %}table-danger{% endif %} dynamic-form-row">
                                    <td>
                                        <div class="form-group">
                                            {% render_field form_detalle.id_producto class="producto-select form-select" %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group">
                                            {% render_field form_detalle.cantidad class="form-control" %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group">
                                            {% render_field form_detalle.precio_unitario class="precio-input form-control text-end" readonly="true" %}
                                        </div>
                                    </td>
                                    
                                    {% for field in form_detalle.hidden_fields %}
                                        {{ field }}
                                    {% endfor %}

                                    <td class="text-center">
                                        {% if form.instance.pk %}
                                            <div class="form-check form-switch d-inline-block">
                                                {{ form_detalle.DELETE }} 
                                                <label class="form-check-label text-danger" for="{{ form_detalle.DELETE.id_for_label }}">
                                                    {% if form_detalle.instance.pk %}Marcar Eliminar{% else %}Quitar{% endif %}
                                                </label>
                                            </div>
                                        {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-form-row">
                                                <i class="fas fa-trash-alt"></i> Quitar
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if form_detalle.errors %}
                                    <tr>
                                        <td colspan="4">
                                            {% for field_error in form_detalle.errors.values %}
                                                <div class="text-danger small">
                                                    <i class="fas fa-times-circle me-1"></i> {{ field_error|join:", " }}
                                                </div>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}

                            {% with form_detalle=articulos_formset.empty_form %}
                            <tr id="empty-form-template" style="display: none;" class="dynamic-form-row">
                                <td>
                                    <div class="form-group">
                                        {% render_field form_detalle.id_producto class="producto-select form-select" %}
                                    </div>
                                </td>
                                <td>
                                    <div class="form-group">
                                        {% render_field form_detalle.cantidad class="form-control" %}
                                    </div>
                                </td>
                                <td>
                                    <div class="form-group">
                                        {% render_field form_detalle.precio_unitario class="precio-input form-control text-end" readonly="true" %}
                                    </div>
                                </td>
                                {% for field in form_detalle.hidden_fields %}
                                    {{ field }}
                                {% endfor %}
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-form-row">
                                        <i class="fas fa-trash-alt"></i> Quitar
                                    </button>
                                </td>
                            </tr>
                            {% endwith %}
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-success mt-3 shadow-sm" id="add-item-btn">
                    <i class="fas fa-plus-circle me-1"></i> Agregar Nuevo Art铆culo
                </button>
                
                <div class="mt-5 pt-3 border-top text-center">
                    <button type="submit" class="btn btn-lg btn-primary me-3 shadow">
                        <i class="fas fa-save me-2"></i>
                        {% if form.instance.pk %}
                            Guardar Cambios
                        {% else %}
                            Crear Pedido
                        {% endif %}
                    </button>
                    <a href="{% url 'pedidos:pedido_list' %}" class="btn btn-lg btn-secondary shadow">
                        <i class="fas fa-times-circle me-2"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</section>
<section class="py-3"></section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 

<script>
    $(document).ready(function() {
        var $container = $('#formset-container');
        var $totalForms = $('#id_{{ articulos_formset.prefix }}-TOTAL_FORMS');
        var $template = $('#empty-form-template');
        var prefix = '{{ articulos_formset.prefix }}';

        function updateFormIndices() {
            var currentForms = $container.find('.dynamic-form-row:not(#empty-form-template)');
            currentForms.each(function(index) {
                var $row = $(this);
                $row.find(':input, label').each(function() {
                    var name = $(this).attr('name');
                    var id = $(this).attr('id');
                    var htmlFor = $(this).attr('for');

                    if (name) {
                        name = name.replace(new RegExp('^' + prefix + '-(\\d+)-'), prefix + '-' + index + '-');
                        $(this).attr('name', name);
                    }
                    if (id) {
                        id = id.replace(new RegExp('^id_' + prefix + '-(\\d+)-'), 'id_' + prefix + '-' + index + '-');
                        $(this).attr('id', id);
                    }
                    if (htmlFor) {
                        htmlFor = htmlFor.replace(new RegExp('^id_' + prefix + '-(\\d+)-'), 'id_' + prefix + '-' + index + '-');
                        $(this).attr('for', htmlFor);
                    }
                });
            });
            $totalForms.val(currentForms.length);
        }

        // L贸gica para AADIR FILA 
        $('#add-item-btn').on('click', function(e) {
            e.preventDefault();
            
            var newIndex = parseInt($totalForms.val());
            var newFormRow = $template.clone(true);
            var html = newFormRow.html().replace(/__prefix__/g, newIndex);
            newFormRow.html(html);

            newFormRow.removeAttr('id').removeAttr('style');
            $template.before(newFormRow); 
            
            $totalForms.val(newIndex + 1);

            newFormRow.find('select, input').first().focus();
        });

        //ELIMINAR FILA ---
        $container.on('click', '.remove-form-row', function(e) {
            e.preventDefault();
            
            var $row = $(this).closest('.dynamic-form-row');
            var $deleteCheckbox = $row.find('input[id$="-DELETE"]');
            
            if ($deleteCheckbox.length) {
                $deleteCheckbox.prop('checked', true);
                $row.hide(); 
            } else {
                $row.remove();
            }
            updateFormIndices();
        });

        // L贸gica para los switches de eliminaci贸n en edit
        $container.on('change', 'input[id$="-DELETE"]', function() {
            var $row = $(this).closest('.dynamic-form-row');
            if ($(this).is(':checked')) {
                $row.addClass('table-danger');
            } else {
                $row.removeClass('table-danger');
            }
        });
        
        // --- L贸gica AJAX para obtener precio
        $container.on('change', '.producto-select', function() {
            var $select = $(this);
            var productoId = $select.val(); 
            
            var $row = $select.closest('.dynamic-form-row');
            var $precioInput = $row.find('.precio-input');

            if (productoId) {
                $.ajax({
                    url: "{% url 'pedidos:obtener_precio_producto' %}", 
                    data: {
                        'producto_id': productoId 
                    },
                    dataType: 'json',
                    success: function (data) {
                        var precio = parseFloat(data.precio) || 0.00; 
                        $precioInput.val(precio.toFixed(2));
                    },
                    error: function() {
                        console.error("Error al obtener el precio del producto.");
                        $precioInput.val('0.00');
                    }
                });
            } else {
                $precioInput.val('0.00');
            }
        });
        updateFormIndices();
    });
</script>

{% endblock contenido %}